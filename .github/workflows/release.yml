name: Release Desktop App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: false

env:
  TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
  TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      release_body: ${{ steps.changelog.outputs.changelog }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v4
        with:
          configurationJson: |
            {
              "template": "#{{CHANGELOG}}\n\n<details>\n<summary>Uncategorized</summary>\n\n#{{UNCATEGORIZED}}\n</details>",
              "categories": [
                {
                    "title": "## üöÄ Features",
                    "labels": ["feat", "feature"]
                },
                {
                    "title": "## üêõ Fixes",
                    "labels": ["fix", "bug"]
                },
                {
                    "title": "## üì¶ Dependencies",
                    "labels": ["dependencies"]
                }
              ]
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-desktop:
    needs: create-release
    strategy:

      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: universal-apple-darwin
            sidecar_suffix: aarch64-apple-darwin
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            sidecar_suffix: x86_64-pc-windows-msvc
    
    runs-on: ${{ matrix.platform }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: ui/package-lock.json

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust targets (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          rustup target add x86_64-apple-darwin
          rustup target add aarch64-apple-darwin

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Frontend Dependencies
        working-directory: ui
        run: npm ci

      - name: Install Python Dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Python Sidecar
        shell: bash
        run: |
          pyinstaller scraper_sidecar.spec
          mkdir -p src-tauri/binaries
          
          if [ "${{ runner.os }}" == "Windows" ]; then
            cp dist/scraper-sidecar-*.exe "src-tauri/binaries/scraper-sidecar-${{ matrix.sidecar_suffix }}.exe"
          else
            cp dist/scraper-sidecar-* "src-tauri/binaries/scraper-sidecar-x86_64-apple-darwin"
            cp dist/scraper-sidecar-* "src-tauri/binaries/scraper-sidecar-aarch64-apple-darwin"
          fi
          
          ls -la src-tauri/binaries/

      - name: Build Tauri App
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name || inputs.version || 'v0.0.0' }}
          releaseName: "Bay State Scraper ${{ github.ref_name || inputs.version }}"
          releaseBody: ${{ needs.create-release.outputs.release_body }}
          releaseDraft: true
          prerelease: false

  generate-update-manifest:
    needs: build-desktop
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Generate update manifest
        run: |
          echo "Update manifest will be generated by tauri-action"
          echo "Make sure to publish the release to trigger update checks"
